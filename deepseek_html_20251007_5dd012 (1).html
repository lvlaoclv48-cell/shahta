<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FaidikApp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            width: 100%;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 25px;
            border-bottom: 2px solid #333;
        }
        
        .logo {
            font-size: 2.2rem;
            font-weight: bold;
            color: #fff;
            text-align: center;
        }
        
        .logo span {
            color: #4CAF50;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 25px;
            flex: 1;
        }
        
        .search-section {
            background: #111;
            border-radius: 15px;
            padding: 35px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .phone-input {
            padding: 18px;
            font-size: 1.1rem;
            background: #222;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            outline: none;
            width: 100%;
            transition: all 0.3s;
        }
        
        .phone-input:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        .search-type {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .search-type-btn {
            flex: 1;
            padding: 14px;
            background: #222;
            border: 1px solid #444;
            border-radius: 8px;
            color: #aaa;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-width: 130px;
        }
        
        .search-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .search-type-btn.active {
            background: #333;
            color: #fff;
            border-color: #4CAF50;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .search-btn {
            padding: 18px;
            background: #333;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-weight: bold;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .search-btn:hover {
            background: #444;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }
        
        .action-btn {
            flex: 1;
            padding: 14px;
            background: #222;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .action-btn:hover {
            background: #333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            margin-top: 25px;
        }
        
        .result-item {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #333;
            transition: all 0.3s;
        }
        
        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .valid {
            background: #1a3c1a;
            color: #4CAF50;
            border-color: #2E7D32;
        }
        
        .invalid {
            background: #3c1a1a;
            color: #F44336;
            border-color: #C62828;
        }
        
        .error {
            background: #3c3c1a;
            color: #FFC107;
            border-color: #FF8F00;
        }
        
        .checking {
            background: #2a2a2a;
            color: #aaa;
        }
        
        .service-name {
            font-size: 0.9rem;
            color: #ccc;
            font-weight: normal;
        }
        
        .status {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .footer {
            background: #111;
            padding: 25px 0;
            text-align: center;
            margin-top: 40px;
            color: #666;
            font-size: 0.9rem;
            border-top: 2px solid #333;
        }
        
        .total-result {
            text-align: center;
            padding: 25px;
            margin-top: 25px;
            border-radius: 10px;
            font-size: 1.3rem;
            font-weight: bold;
            display: none;
        }
        
        .total-valid {
            background: #1a3c1a;
            color: #4CAF50;
            border: 1px solid #2E7D32;
        }
        
        .total-invalid {
            background: #3c1a1a;
            color: #F44336;
            border: 1px solid #C62828;
        }
        
        .api-result {
            background: #1a1a3c;
            color: #fff;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .result-data {
            margin-top: 15px;
            padding: 15px;
            background: #2a2a4a;
            border-radius: 8px;
            border: 1px solid #444;
        }
        
        .info-line {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #444;
        }
        
        .info-label {
            color: #aaa;
            font-weight: 500;
        }
        
        .info-value {
            color: #fff;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.4s;
            border-radius: 3px;
        }

        .api-counter {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .section-title {
            color: #4CAF50;
            margin: 15px 0 10px 0;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .json-container {
            background: #1a1a2a;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #444;
            max-height: 400px;
            overflow-y: auto;
        }

        .json-item {
            background: #2a2a3a;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #4CAF50;
        }

        .json-field {
            display: flex;
            margin: 4px 0;
            padding: 2px 0;
        }

        .json-key {
            color: #4CAF50;
            font-weight: bold;
            min-width: 120px;
        }

        .json-value {
            color: #fff;
            flex: 1;
        }

        .database-badge {
            background: #FF9800;
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .leak-item {
            background: #3a1a1a;
            border-left: 4px solid #F44336;
        }

        .social-item {
            background: #1a3a3a;
            border-left: 4px solid #00BCD4;
        }

        .finance-item {
            background: #2a3a1a;
            border-left: 4px solid #8BC34A;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .results, .results * {
                visibility: visible;
            }
            .results {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .action-buttons, .search-section {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .search-section {
                padding: 25px;
            }
            
            .search-type {
                flex-direction: column;
            }
            
            .search-type-btn {
                min-width: auto;
            }
            
            .json-field {
                flex-direction: column;
            }
            
            .json-key {
                min-width: auto;
                margin-bottom: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Faidik<span>App</span></div>
    </div>
    
    <div class="container">
        <div class="search-section">
            <div class="input-group">
                <input type="text" class="phone-input" placeholder="Введите номер телефона (например: +79161234567)" id="phoneInput">
                
                <div class="search-type">
                    <button class="search-type-btn active" data-type="validity">Проверка на валид</button>
                    <button class="search-type-btn" data-type="api">Поиск по API</button>
                    <button class="search-type-btn" data-type="freeapi">Поиск по FREEAPI</button>
                </div>
                
                <button class="search-btn" id="searchBtn">ПРОВЕРИТЬ</button>
                
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                
                <div class="api-counter" id="apiCounter"></div>
                
                <div class="action-buttons">
                    <button class="action-btn" id="printBtn">🖨️ Печать</button>
                    <button class="action-btn" id="downloadBtn">📥 Скачать TXT</button>
                </div>
            </div>
            
            <div class="results" id="results">
                <!-- Результаты будут добавлены динамически -->
            </div>
            
            <div class="total-result" id="totalResult"></div>
        </div>
    </div>
    
    <div class="footer">
        <p>Вечная ссылка: FaidikSearch.xyz</p>
    </div>

    <script>
        // Текущий выбранный тип поиска
        let currentSearchType = 'validity';
        let currentSearchInProgress = false;
        
        // Основной DepSearch API
        const DEPSEARCH_API = {
            name: "DepSearch API",
            url: (phone) => `https://api.depsearch.digital/quest=${phone}?token=03IuH83d9BntICttmi0cVMFGicb6gi4h`,
            process: (data) => {
                console.log("Raw DepSearch Data:", data);
                return data; // Возвращаем сырые данные для специальной обработки
            }
        };

        // Бесплатные API для проверки номеров
        const FREE_PHONE_APIS = [
            {
                name: "AbstractAPI Phone Validation",
                url: (phone) => `https://phonevalidation.abstractapi.com/v1/?api_key=demokey&phone=${phone}`,
                process: (data) => ({
                    valid: data.valid ? '✅ Да' : '❌ Нет',
                    number: data.number || 'Неизвестно',
                    format: data.format?.international || 'Неизвестно',
                    country: data.country?.name || 'Неизвестно',
                    location: data.location || 'Неизвестно',
                    carrier: data.carrier || 'Неизвестно',
                    line_type: data.type || 'Неизвестно'
                })
            },
            {
                name: "NumVerify API",
                url: (phone) => `http://apilayer.net/api/validate?access_key=free&number=${phone}`,
                process: (data) => ({
                    valid: data.valid ? '✅ Да' : '❌ Нет',
                    number: data.number || 'Неизвестно',
                    country: data.country_name || 'Неизвестно',
                    location: data.location || 'Неизвестно',
                    carrier: data.carrier || 'Неизвестно',
                    line_type: data.line_type || 'Неизвестно'
                })
            },
            {
                name: "HackerTarget Lookup",
                url: (phone) => `https://api.hackertarget.com/phonenumberlookup/?q=${phone}`,
                process: (data) => ({
                    result: data.includes('error') ? 'Ошибка API' : data.substring(0, 200) + '...'
                })
            },
            {
                name: "AbstractAPI Demo",
                url: (phone) => `https://phonevalidation.abstractapi.com/v1/?api_key=DEMO&phone=${phone}`,
                process: (data) => ({
                    valid: data.valid ? '✅ Да' : '❌ Нет',
                    number: data.number || 'Неизвестно',
                    country: data.country?.name || 'Неизвестно',
                    carrier: data.carrier || 'Неизвестно',
                    line_type: data.type || 'Неизвестно'
                })
            },
            {
                name: "VeriPhone API",
                url: (phone) => `https://api.veriphone.io/v2/verify?phone=${phone}`,
                process: (data) => ({
                    valid: data.phone_valid ? '✅ Да' : '❌ Нет',
                    number: data.phone || 'Неизвестно',
                    country: data.country || 'Неизвестно',
                    carrier: data.carrier || 'Неизвестно',
                    line_type: data.phone_type || 'Неизвестно'
                })
            }
        ];

        // Функция для красивого отображения JSON данных из DepSearch
        function renderDepSearchData(data) {
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="font-weight: bold; font-size: 1.1rem;">${DEPSEARCH_API.name}</span>
                    <span class="status" style="color: #4CAF50;">УСПЕХ</span>
                </div>
                <div class="result-data">
            `;

            // Обрабатываем основные поля
            if (data.phone || data.number) {
                html += `<div class="section-title">📱 Основная информация:</div>`;
                html += createInfoLine('Номер телефона', data.phone || data.number);
            }

            if (data.status) {
                html += createInfoLine('Статус', data.status);
            }

            if (data.valid !== undefined) {
                html += createInfoLine('Валидность', data.valid ? '✅ Да' : '❌ Нет');
            }

            // Обрабатываем результаты (results)
            if (data.results && Array.isArray(data.results)) {
                html += `<div class="section-title">📊 Найденные данные:</div>`;
                html += `<div class="json-container">`;
                
                data.results.forEach((result, index) => {
                    const itemClass = getItemClass(result.data);
                    html += `
                        <div class="json-item ${itemClass}">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <strong>Запись ${index + 1}</strong>
                                <span class="database-badge">${result.data || 'Неизвестно'}</span>
                            </div>
                    `;
                    
                    // Отображаем поля записи
                    for (const [key, value] of Object.entries(result)) {
                        if (key !== 'data') {
                            const formattedValue = formatJsonValue(key, value);
                            if (formattedValue) {
                                html += `
                                    <div class="json-field">
                                        <span class="json-key">${formatKey(key)}:</span>
                                        <span class="json-value">${formattedValue}</span>
                                    </div>
                                `;
                            }
                        }
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            }

            // Обрабатываем другие массивы
            const arrayFields = ['leaks', 'social_media', 'financial_data', 'additional_info'];
            arrayFields.forEach(field => {
                if (data[field] && Array.isArray(data[field])) {
                    html += `<div class="section-title">${getArrayTitle(field)}:</div>`;
                    html += `<div class="json-container">`;
                    
                    data[field].forEach((item, index) => {
                        html += `
                            <div class="json-item ${getItemClass(field)}">
                                <strong>${getArrayItemTitle(field)} ${index + 1}</strong>
                        `;
                        
                        if (typeof item === 'object') {
                            for (const [key, value] of Object.entries(item)) {
                                const formattedValue = formatJsonValue(key, value);
                                if (formattedValue) {
                                    html += `
                                        <div class="json-field">
                                            <span class="json-key">${formatKey(key)}:</span>
                                            <span class="json-value">${formattedValue}</span>
                                        </div>
                                    `;
                                }
                            }
                        } else {
                            html += `
                                <div class="json-field">
                                    <span class="json-value">${formatJsonValue(field, item)}</span>
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                }
            });

            // Обрабатываем одиночные объекты
            const objectFields = ['user_info', 'operator_info', 'location_info', 'risk_assessment'];
            objectFields.forEach(field => {
                if (data[field] && typeof data[field] === 'object') {
                    html += `<div class="section-title">${formatKey(field)}:</div>`;
                    html += `<div class="json-container">`;
                    html += `<div class="json-item">`;
                    
                    for (const [key, value] of Object.entries(data[field])) {
                        const formattedValue = formatJsonValue(key, value);
                        if (formattedValue) {
                            html += `
                                <div class="json-field">
                                    <span class="json-key">${formatKey(key)}:</span>
                                    <span class="json-value">${formattedValue}</span>
                                </div>
                            `;
                        }
                    }
                    
                    html += `</div></div>`;
                }
            });

            html += `</div>`;
            return html;
        }

        // Функция для определения класса элемента по типу данных
        function getItemClass(dataType) {
            if (!dataType) return '';
            
            const type = String(dataType).toLowerCase();
            if (type.includes('leak') || type.includes('breach')) return 'leak-item';
            if (type.includes('social') || type.includes('contact')) return 'social-item';
            if (type.includes('financial') || type.includes('bank') || type.includes('sber')) return 'finance-item';
            return '';
        }

        // Функция для форматирования значений JSON
        function formatJsonValue(key, value) {
            if (value === null || value === undefined || value === '') return null;
            
            // Булевы значения
            if (typeof value === 'boolean') {
                return value ? '✅ Да' : '❌ Нет';
            }
            
            // Числовые значения
            if (typeof value === 'number') {
                return key.toLowerCase().includes('sum') ? `${value} ₽` : String(value);
            }
            
            // Строковые значения
            if (typeof value === 'string') {
                // Длинные текстовые поля
                if (value.length > 100) {
                    return value.substring(0, 100) + '...';
                }
                
                // Специальные строковые значения
                if (value === 'ACTIVE' || value === 'Y') return '✅ Активен';
                if (value === 'INACTIVE' || value === 'N') return '❌ Неактивен';
                if (value === 'NULL') return '—';
                
                return value;
            }
            
            // Объекты и массивы
            if (typeof value === 'object') {
                return JSON.stringify(value).substring(0, 80) + '...';
            }
            
            return String(value);
        }

        // Функция для получения заголовка массива
        function getArrayTitle(field) {
            const titles = {
                'leaks': '🔐 Утечки данных',
                'social_media': '👥 Социальные сети',
                'financial_data': '💳 Финансовые данные',
                'additional_info': '📋 Дополнительная информация'
            };
            return titles[field] || formatKey(field);
        }

        // Функция для получения заголовка элемента массива
        function getArrayItemTitle(field) {
            const titles = {
                'leaks': 'Утечка',
                'social_media': 'Профиль',
                'financial_data': 'Операция',
                'additional_info': 'Запись'
            };
            return titles[field] || 'Элемент';
        }

        // Функция для создания CORS прокси
        function getCorsProxy(url) {
            return `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
        }

        // Функция очистки результатов
        function clearResults() {
            const resultsDiv = document.getElementById('results');
            const totalResultDiv = document.getElementById('totalResult');
            const progressBar = document.getElementById('progressBar');
            const apiCounter = document.getElementById('apiCounter');
            
            resultsDiv.innerHTML = '';
            totalResultDiv.style.display = 'none';
            progressBar.style.width = '0%';
            apiCounter.textContent = '';
        }

        // Функция проверки валидности номера
        async function validatePhone() {
            if (currentSearchInProgress) return;
            
            const phoneInput = document.getElementById('phoneInput');
            const phoneNumber = phoneInput.value.trim();
            
            if (!phoneNumber) {
                alert('Введите номер телефона');
                return;
            }

            clearResults();
            setButtonsState(true);
            currentSearchInProgress = true;

            let validCount = 0;
            let totalChecked = 0;
            const totalChecks = 5;
            
            const checks = [
                { name: "Формат E.164", check: () => /^\+[1-9]\d{1,14}$/.test(phoneNumber) },
                { name: "Длина номера", check: () => phoneNumber.length >= 10 && phoneNumber.length <= 15 },
                { name: "Код страны", check: () => ['+7', '+1', '+44', '+49', '+33', '+86'].some(code => phoneNumber.startsWith(code)) },
                { name: "Российский оператор", check: () => {
                    if (!phoneNumber.startsWith('+7')) return false;
                    const code = phoneNumber.substring(2, 5);
                    return ['910', '915', '916', '917', '919', '985', '986', '903', '905', '906'].includes(code);
                }},
                { name: "Валидный префикс", check: () => !phoneNumber.startsWith('+0') }
            ];
            
            for (let i = 0; i < checks.length; i++) {
                if (!currentSearchInProgress) break;
                
                const check = checks[i];
                const resultsDiv = document.getElementById('results');
                const progressBar = document.getElementById('progressBar');
                const apiCounter = document.getElementById('apiCounter');
                
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item checking';
                resultItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${check.name} <span class="service-name">проверка...</span></span>
                        <span class="status">...</span>
                    </div>
                `;
                resultsDiv.appendChild(resultItem);
                
                progressBar.style.width = `${((i + 1) / totalChecks) * 100}%`;
                apiCounter.textContent = `Проверка ${i + 1} из ${totalChecks}`;
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                try {
                    const isValid = check.check();
                    totalChecked++;
                    
                    if (isValid) {
                        validCount++;
                        resultItem.className = 'result-item valid';
                        resultItem.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${check.name} <span class="service-name">✓ проверка завершена</span></span>
                                <span class="status">ВАЛИД</span>
                            </div>
                        `;
                    } else {
                        resultItem.className = 'result-item invalid';
                        resultItem.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${check.name} <span class="service-name">✓ проверка завершена</span></span>
                                <span class="status">НЕ ВАЛИД</span>
                            </div>
                        `;
                    }
                } catch (error) {
                    resultItem.className = 'result-item error';
                    resultItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${check.name} <span class="service-name">✗ ошибка проверки</span></span>
                            <span class="status">ОШИБКА</span>
                        </div>
                    `;
                }
            }
            
            if (totalChecked > 0 && currentSearchInProgress) {
                const validPercentage = (validCount / totalChecked) * 100;
                const totalResultDiv = document.getElementById('totalResult');
                totalResultDiv.style.display = 'block';
                
                if (validPercentage >= 60) {
                    totalResultDiv.className = 'total-result total-valid';
                    totalResultDiv.textContent = `ОБЩИЙ РЕЗУЛЬТАТ: ВАЛИД (${validCount}/${totalChecked} проверок)`;
                } else {
                    totalResultDiv.className = 'total-result total-invalid';
                    totalResultDiv.textContent = `ОБЩИЙ РЕЗУЛЬТАТ: НЕ ВАЛИД (${validCount}/${totalChecked} проверок)`;
                }
                
                totalResultDiv.scrollIntoView({ behavior: 'smooth' });
            }
            
            setButtonsState(false);
            currentSearchInProgress = false;
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('apiCounter').textContent = 'Проверка завершена';
        }

        // Функция поиска по DepSearch API
        async function searchByAPI() {
            if (currentSearchInProgress) return;
            
            const phoneInput = document.getElementById('phoneInput');
            const phoneNumber = phoneInput.value.trim();
            
            if (!phoneNumber) {
                alert('Введите номер телефона');
                return;
            }
            
            clearResults();
            setButtonsState(true);
            currentSearchInProgress = true;

            const resultsDiv = document.getElementById('results');
            const progressBar = document.getElementById('progressBar');
            const apiCounter = document.getElementById('apiCounter');
            
            const loadingItem = document.createElement('div');
            loadingItem.className = 'result-item checking';
            loadingItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${DEPSEARCH_API.name} <span class="service-name">подключение к серверу...</span></span>
                    <span class="status">...</span>
                </div>
            `;
            resultsDiv.appendChild(loadingItem);
            
            try {
                progressBar.style.width = '30%';
                apiCounter.textContent = 'Запрос к DepSearch API...';
                
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Таймаут запроса: сервер не отвечает')), 10000)
                );
                
                const fetchPromise = fetch(DEPSEARCH_API.url(phoneNumber));
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                progressBar.style.width = '70%';
                apiCounter.textContent = 'Обработка данных...';
                
                const data = await response.json();
                
                progressBar.style.width = '100%';
                apiCounter.textContent = 'Данные получены';
                
                if (currentSearchInProgress) {
                    loadingItem.className = 'api-result';
                    loadingItem.innerHTML = renderDepSearchData(data);
                }
                
            } catch (error) {
                if (currentSearchInProgress) {
                    loadingItem.className = 'result-item error';
                    loadingItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${DEPSEARCH_API.name} <span class="service-name">✗ ошибка подключения</span></span>
                            <span class="status">ОШИБКА</span>
                        </div>
                        <div style="margin-top: 10px; color: #FFC107; font-size: 0.9rem;">
                            ${error.message}
                        </div>
                    `;
                }
            }
            
            setButtonsState(false);
            currentSearchInProgress = false;
        }

        // Функция создания строки информации
        function createInfoLine(label, value) {
            return `
                <div class="info-line">
                    <span class="info-label">${label}:</span>
                    <span class="info-value">${value || 'Неизвестно'}</span>
                </div>
            `;
        }

        // Функция форматирования ключей для отображения
        function formatKey(key) {
            const formatted = key.replace(/\./g, ' ')
                               .replace(/([A-Z])/g, ' $1')
                               .replace(/_/g, ' ')
                               .replace(/\b\w/g, l => l.toUpperCase())
                               .trim();
            
            return formatted;
        }

        // Функция поиска по бесплатным API
        async function searchByFreeAPI() {
            if (currentSearchInProgress) return;
            
            const phoneInput = document.getElementById('phoneInput');
            const phoneNumber = phoneInput.value.trim();
            
            if (!phoneNumber) {
                alert('Введите номер телефона');
                return;
            }
            
            clearResults();
            setButtonsState(true);
            currentSearchInProgress = true;

            const resultsDiv = document.getElementById('results');
            const progressBar = document.getElementById('progressBar');
            const apiCounter = document.getElementById('apiCounter');
            
            const totalApis = FREE_PHONE_APIS.length;
            let completedApis = 0;
            let successfulApis = 0;
            
            for (let i = 0; i < FREE_PHONE_APIS.length; i++) {
                if (!currentSearchInProgress) break;
                
                const api = FREE_PHONE_APIS[i];
                
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item checking';
                resultItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${api.name} <span class="service-name">подключение...</span></span>
                        <span class="status">...</span>
                    </div>
                `;
                resultsDiv.appendChild(resultItem);
                
                completedApis++;
                progressBar.style.width = `${(completedApis / totalApis) * 100}%`;
                apiCounter.textContent = `API ${completedApis} из ${totalApis} (Успешно: ${successfulApis})`;
                
                try {
                    const response = await fetch(getCorsProxy(api.url(phoneNumber)));
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const processedData = api.process(data);
                    
                    successfulApis++;
                    
                    if (currentSearchInProgress) {
                        resultItem.className = 'api-result';
                        resultItem.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="font-weight: bold; font-size: 1.1rem;">${api.name}</span>
                                <span class="status" style="color: #4CAF50;">УСПЕХ</span>
                            </div>
                            <div class="result-data">
                                ${Object.entries(processedData).map(([key, value]) => createInfoLine(formatKey(key), value)).join('')}
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    if (currentSearchInProgress) {
                        resultItem.className = 'result-item error';
                        resultItem.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${api.name} <span class="service-name">✗ ошибка API</span></span>
                                <span class="status">ОШИБКА</span>
                            </div>
                            <div style="margin-top: 10px; color: #FFC107; font-size: 0.9rem;">
                                ${error.message}
                            </div>
                        `;
                    }
                }
                
                await new Promise(resolve => setTimeout(resolve, 800));
            }
            
            setButtonsState(false);
            currentSearchInProgress = false;
            apiCounter.textContent = `Завершено: ${completedApis} API (Успешно: ${successfulApis})`;
        }

        function setButtonsState(disabled) {
            const buttons = ['searchBtn', 'printBtn', 'downloadBtn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                btn.disabled = disabled;
            });
            document.getElementById('searchBtn').textContent = disabled ? 'ПОДКЛЮЧЕНИЕ...' : 'ПРОВЕРИТЬ';
        }

        // Функция печати результатов
        function printResults() {
            window.print();
        }

        // Функция скачивания результатов в TXT
        function downloadResults() {
            const resultsDiv = document.getElementById('results');
            const phoneInput = document.getElementById('phoneInput');
            const phoneNumber = phoneInput.value.trim();
            
            if (!phoneNumber) {
                alert('Введите номер телефона и выполните поиск');
                return;
            }
            
            let content = "Вечная ссылка: FaidikSearch.xyz\n\n";
            content += `Результаты поиска для номера: ${phoneNumber}\n`;
            content += `Тип поиска: ${getSearchTypeName(currentSearchType)}\n`;
            content += `Дата: ${new Date().toLocaleString()}\n\n`;
            
            const resultItems = resultsDiv.querySelectorAll('.result-item, .api-result');
            
            if (resultItems.length === 0) {
                content += "Нет данных для отображения\n";
            } else {
                resultItems.forEach(item => {
                    const text = item.textContent.replace(/\s+/g, ' ').trim();
                    content += text + "\n\n";
                });
            }
            
            content += "\nВечная ссылка: FaidikSearch.xyz";
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FaidikApp_${phoneNumber}_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function getSearchTypeName(type) {
            const names = {
                'validity': 'Проверка на валид',
                'api': 'Поиск по API', 
                'freeapi': 'Поиск по FREEAPI'
            };
            return names[type] || 'Неизвестный тип';
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.search-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentSearchInProgress = false;
                    
                    document.querySelectorAll('.search-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentSearchType = this.getAttribute('data-type');
                    
                    clearResults();
                });
            });
            
            document.getElementById('searchBtn').addEventListener('click', function() {
                switch(currentSearchType) {
                    case 'validity': validatePhone(); break;
                    case 'api': searchByAPI(); break;
                    case 'freeapi': searchByFreeAPI(); break;
                }
            });
            
            document.getElementById('phoneInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('searchBtn').click();
            });
            
            document.getElementById('printBtn').addEventListener('click', printResults);
            document.getElementById('downloadBtn').addEventListener('click', downloadResults);
            
            document.getElementById('phoneInput').value = '+79161234567';
        });
    </script>
</body>
</html>